## Курс "Администратор Linux" OTUS.RU

### Методические указания по выполнению практической работы "Динамическая маршрутизация".

Домашняя работа:  

Для того, чтобы получить практические навыки работы с динамической маршрутизацией, утилитами ip, traceroute, tracepath и развёртыванием простого однозонного OSPF предлагается следующее: 

1. Развернуть 3 виртуальных машины;
2. Объединить эти виртуальные машины разными виртуальными каналами;
3. Настроить OSPFv2 между виртуальными машинами на базе quagga;
4. Настроить асимметричную маршрутизацию;
5. Восстановить симметричную маршрутизацию не уменьшая цену интерфейса из п.4.

Для выполнения потребуется хост виртуализации с поддержкой создания изолированных сетей. Рекомендуется использовать хост с ОС Linux и установленном на нём ПО virtualbox и vagrant. Внутри виртуальных машин также потребуется ОС Linux и установленный пакет quagga.

**Формат сдачи:**
- **Vagrantfile + ansible**  
- **Продемонстрировать работу симметричной/асимметричной маршрутизации скриншотами или выводом консоли**

Готовый к развёртыванию стенд необходимо разместить в git и приложить ссылку на репозиторий в "Чат с преподавателем" в соответствующей теме в Личном кабинете. Репозиторий, соответственно, должен быть публичным. Дополнительные схемы, скриншоты, выводы консоли и комментарии в README приветствуются.

Данные методические указания написаны с учётом того, что внутри ВМ используется дистрибутив CentOS 7 из vagrant box centos/7 версии 1905.1. При использовании другой ОС вам необходимо будет адаптировать указания к используемым ОС и ПО.

На все возникшие вопросы можно получить ответ в переписке в чате с преподавателем или, что более рекомендуется, в slack вашей группы.

### Критерии оценки

- Есть схема с указанием устройств, каналов, интерфейсов и адресов (1 балл); 
- Предоставлен стенд Vagrant с развёртыванием ansible (1 балл);
- Предоставленный стенд имеет корректно настроенную асимметричную маршрутизацию (2 балла);
- Есть описание и демонстрация того, как восстановить симметричную маршрутизация на стенде не уменьшая цены интерфейсов (1 балл).

Выполнение первых трёх пунктов являются необходимым для получения зачета по базовому домашнему заданию.

### Построение схемы сети

При проектировании сети любой сложности является хорошим тоном иметь схемы и таблицы с указанием, как минимум, устройств, каналов, интерфейсов и адресов. В нашем случае это будут 3 программных маршрутизатора на базе linux, объединенных независимыми каналами. При этом, один из этих маршрутизаторов, в отличие от остальных, должен иметь доступ к сети Интернет и будет являться шлюзом для остальных. IP-адресация в пределах независимых каналов должна быть уникальной.  
  
Предлагается использовать следующую схему ([исходный файл в формате draw.io](docs/ospfv2.drawio) расположен в директории docs):  
![](docs/ospfv2.png)  
  
Таблица соответствия каналов и адресов.  
| Канал | Адресация |
|-------|-----------|
| ISP   | DHCP client    |
| link1 | 172.16.1.0/24 |
| link2 | 172.16.2.0/24 |
| link3 | 172.16.3.0/24 |
  
Таблица адресов на интерфейсах устройств.  
| Устройство | Интерфейс | Адрес |
|------------|-----------|-------|
| R1 | lo | 10.0.0.1/32 | 
| R1 | eth0 | vagrant DHCP | 
| R1 | eth1 | 172.16.1.1/24 |
| R1 | eth2 | 172.16.2.1/24 | 
| R2 | lo | 10.0.0.2/32 | 
| R2 | eth0 | vagrant DHCP | 
| R2 | eth1 | 172.16.1.2/24 |
| R2 | eth2 | 172.16.3.2/24 | 
| R3 | lo | 10.0.0.3/32 | 
| R3 | eth0 | vagrant DHCP | 
| R3 | eth1 | 172.16.2.3/24 |
| R3 | eth2 | 172.16.3.3/24 | 
  
### Подготовка vagrantfile

В данной работе нам потребуется развернуть 3 ВМ, объединенных независимыми приватными сетями (private_networks).  
Пример базового vagrantfile, который соответствует требованиям, приведён [здесь](docs/Vagrantfile).  
После развертывания ВМ обязательно убедитесь в том, что машины видят друг друга в рамках используемых каналов связи (ping и т.п.)

### Подготовка ОС

Прежде чем приступать к настройке quagga нужно подготовить ОС к роли программного маршрутизатора, а именно:
- включить пересылку пакетов между интерфейсами (forwarding);
- выключить (или включить "мягкий режим") фильтрации.

Полную информацию об этих параметрах можно получить [тут](https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt). Нам же потребуется привести параметры sysctl на постоянной основе (```/etc/sysctl.d/router.conf```) к следующим значениям:  

| Параметр | Значение | Комментарий |
|----------|----------|-------------|
| net.ipv4.ip_forward | 1 | Разрешена пересылка пакетов IPv4 между интерфейсами (глобально) |
| net.ipv4.conf.all.forwarding | 1 | Разрешена пересылка пакетов IPv4 (поинтерфейсно) |
| net.ipv4.conf.all.rp_filter | 2 | "Мягкий" режим проверки адреса источника пакетов IPv4 |

Также правилом хорошего тона считается задать имя каждому устройству и синхронизировать время с единым источником - это здорово поможет при отладке.

### Подготовка loopback

Для удобства обслуживания сети и работы с ней неплохо иметь уникальный адрес каждого сетевого устройства независимо от адресов, которые назначены на интерфейсы. Носителем такого адреса обычно делают loopback-интерфейс, т.к. он всегда включен и по умолчанию функционирует на всегда известном интерфейсе конкретного устройства. При этом помним, что на интерфейсе **lo** уже есть адрес **127.0.0.1/8**, откуда следует, что для закрепления дополнительного статического адреса нам понадобится создать субинтерфейс **lo:2** с помощью конфигурационного файла **ifcfg-lo.2**. К примеру:  
  
```
DEVICE=lo:2
IPADDR=10.0.0.1
PREFIX=32
NETWORK=10.0.0.1
ONBOOT=yes
```

Для применения изменений нужно перезапустить сетевую подсистему. Обратите внимание: т.к. в примере мы используем адрес **10.0.0.1/32**, то адрес такой сети будет **10.0.0.1** (не путать с маской 255.255.255.255).  
Такие loopback адреса нужно назначить на каждом сетевом устройстве по возможности.

### Установка ПО

Т.к. пакет quagga входит в стандартный набор пакетов CentOS 7, то установка производится простым набором команды ```yum install quagga -y```. Однако следует иметь в виду некоторые сопутствующие детали:
- по умолчанию устанавливается только конфигурационный файл демона управления zebra.conf;
- не устанавливаются конфигурационные файлы демонов ospfd, bgpd и пр.;
- не выдаются разрешения selinux;
- все демоны по умолчанию выключены и исключены из автозапуска.

Разрешения selinux выдаются переключателем ```zebra_write_config```. Конфигурационные файлы располагаются по пути ```/etc/quagga/```. Нам потребуется создать файл ```/etc/quagga/ospfd.conf``` и выдать ему права ```quagga:quaggavt```. Этого будет достаточно для работы демона ospfd и возможности управляющей утилите zebra писать в конфигурационные файлы.  
Теперь можно запустить демоны zebra и ospfd:
```
systemctl enable zebra
systemctl enable ospfd
systemctl start zebra
systemctl start ospfd
```
  
Для проверки запустите от root утилиту ```vtysh``` и наберите или ```wr```, или ```copy running-config startup-config```. В результате должно появиться сообщение о том, что конфигурационные файлы были успешно сохранены.

### Настройка firewall для OSPF

Настройка firewall сводится к разрешению **протокола 89** и, если предыдущего правила недостаточно, разрешению трафика между IP-адресами соседей и **multicast адресами 224.0.0.5, 224.0.0.6**.  
Убедитесь в том, что firewall включен и нормально функционирует: ```systemctl status firewalld```. В составе дистрибутива CentOS 7 сервису firewalld нужно добавить протокол ospf в список разрешённых командой: ```firewall-cmd --add-protocol=ospf --permanent```. Не забудьте применить настройки firewalld командой: ```firewall-cmd --reload```. Убедитесь в том, что настройки применены командой ```firewall-cmd --list-all``` (или ```iptables-save | grep ospf``` как вариант).

### Подготовка статических маршрутов

На всех маршрутизаторах кроме R1 нужно отключить маршруты по умолчанию, которые получаются от vagrant DHCP на интерфейсе eth0. Наиболее простой вариант: добавить параметр ```DEFROUTE=no``` в конфигурационный файл ifcfg-eth0 и перезапустить сетевую подсистему. Также есть варианты с nmcli на ваше усмотрение. Убедитесь в отсутствии маршрута по умолчанию в таблицах маршрутизации везде, кроме R1 (команды ```ip ro```).  
Обратите внимание на то, что **после этой операции вы потеряете доступ к Интернет на этих машинах**, поэтому все нужные пакеты и утилиты (tcpdump, etc.) должны быть установлены заранее.

### Утилита vtysh

Утилита vtysh используется для конфигурирования программного маршрутизатора. Важно помнить, что все изменения, выполненные в vtysh, работают только в памяти демона до его перезапуска. Поэтому **не забывайте сохранять** конфигурацию командами ```wr``` или ```copy running-config startup-config```.
  
При запуске утилиты vtysh вы попадаете в непривилегированный режим. Здесь вы не можете вносить изменения в конфигурацию маршрутизатора, но можете просматривать его текущее состояние. Список доступных команд можно получить введя ```?```. Также здесь действует автодополнение клавишей ```TAB```. Команды можно сокращать до однозначно интерпретируемого вида: например, команду ```copy running-config startup-config``` можно сократить до ```copy run start```.

Из наиболее часто используемых команд непривилегированного режима стоит отметить команду ```show```. У неё много опций: например, ```show ip route``` (короткий вариант ```sh ip ro```) выведет вам таблицу маршрутизации zebra (не путать с таблицей маршрутизации операционной системы). Лучшие маршруты zebra будут отмечены звёздочкой и именно они попадут в таблицу маршрутизации ОС.

Для входа в режим настройки маршрутизатора используется команда ```configure terminal``` (```conf t```). Выход из этого режима осуществляется командой ```exit```. В данном режиме напрямую недоступны команды непривилегированного режима, однако к ним можно получить доступ с помощью ключевого слова ```do```, например, ```do sh ip ro```.

Если была допущена ошибка в конфигурировании, например, была введена команда ```router-id 10.0.1.1``` вместо ```router-id 10.0.0.1```, то поправить ошибку можно сначала устранив некорректную команду используя ключевое слово ```no```, а после этого ввести правильную команду. Например:
```
router-id 10.0.1.1
no router-id 10.0.1.1
router-id 10.0.0.1
```  
Ошибочную строку для удаления всегда можно увидеть выполнив ```do sh run``` или ```sh run``` в зависимости от режима, в котором сейчас находитесь.
  
### Режим конфигурирования маршрутизатора

В режиме ```conf t``` есть множество команд. Нам для успешного выполнения работы потребуются 2 режима ```conf t```: режим настройки интерфейсов и режим настройки процесса OSPF.  
В режим настройки интерфейса можно попасть командой ```interface имя интерфейса```, например, ```interface eth0```. Выход также по команде ```exit```. В данном режиме, очевидно, мы можем настраивать разные интерфейс-специфичные опции, в т.ч. те, которые начинаются с ```ip ospf ...```.  
В режим настройки процесса OSPF можно попасть командой ```router ospf```. Выход также по ```exit```.

### Настройка процесса OSPF

Базовая настройка процесса OSPF сводится к следующим шагам:
- включение процесса OSPF;
- установка router-id;
- перевод всех интерфейсов в пассивный режим и разрешение только тех, в пределах которых будет работать OSPF;
- назначение сетей, информация о которых будет передаваться соседям от конкретного маршрутизатора;
- (опционально) объявление специальных маршрутов для автономной системы OSPF, например, маршрута по умолчанию.

Соответственно, ниже приведён пример конфигурации для маршрутизатора R1:
```
router ospf
 router-id 10.0.0.1
 passive-interface default
 no passive-interface eth1
 no passive-interface eth2
 network 10.0.0.1/32 area 0
 network 172.16.1.0/24 area 0
 network 172.16.2.0/24 area 0
 default-information originate
```
  
Аналогичная настройка производится на других маршрутизаторах автономной системы, но без команды ```default-information originate```, т.к. именно она распространяет маршрут по умолчанию через маршрутизатор R1 и указывает на точку выхода из автономной системы. **Не забудьте сохранить конфигурацию!** После сохранения можно посмотреть содержимое файлов ```/etc/quagga/zebra.conf``` и ```/etc/quagga/ospfd.conf``` - они понадобятся для шаблонов j2 в ansible.

Полное описание всех команды можно найти на [официальном ресурсе](https://www.quagga.net/docs.html). Пройдемся по приведённым выше командам.  

- ```router ospf``` - входим в режим конфигурирования процесса OSPF;
- ```router-id 10.0.0.1``` - назначаем **уникальный(!) идентификатор маршрутизатора в автономной системе OSPF**; на самом деле это просто число в виде IP-адреса; для удобства лучше чтобы оно совпадало с числовым значением адреса на loopback;
- ```passive-interface default``` - перестаём рассылать hello-пакеты со всех интерфейсов в целях безопасности;
- ```no passive-interface eth1``` - снимаем блокировку рассылки hello-пакетов с интерфейсов, на которых ожидаем соседей OSPF;
- ```network 10.0.0.1/32 area 0``` - указываем сеть, информация о которой будет рассылаться в автономной системе OSPF и принадлежность этой сети к конкретной зоне OSPF.

В результате корректной настройки в таблицах маршрутизации на каждом роутере должны добавиться:
- два маршрута до loopback-адресов соседних маршрутизаторов;
- путь до удалённой сети через два других маршрутизатора.  
Отличить эти записи можно по содержанию в них ```proto zebra```, т.к. источником этих маршрутов будет являться демон zebra из пакета quagga. Также убедитесь в том, что адреса интерфейсов маршрутизаторов в удалённой сети доступны с каждого маршрутизатора в сети (ping, traceroute).

### Настройка опций OSPF на интерфейсах для асимметричной маршрутизации

В процессе настройки асимметричной маршрутизации понадобится изменить интерфейс-специфичные опции, такие как "цена интерфейса". Делается это в режиме конфигурирования интерфейса после входа в режим ```conf t```:
```
interface eth1
 ip ospf cost 1000
```
  
Список всех доступных опций можно просмотреть набрав ```ip ospf``` и нажав клавишу TAB.

### Проверка состояния OSPF

Текущую информацию о процессе OSPF можно получить из непривилегированного режима командой ```show ip ospf ...```. Из режима конфигурирования маршрутизатора - те же команды с ключевым словом ```do```.

### Проверка асимметричной маршрутизации

Для того, чтобы убедиться в том, что трафик ходит по заданному маршруту можно использовать ```tcpdump``` ожидая ICMP или UDP пакеты в зависимости от того какие инструменты трассировки и диагностики используются (ping, traceroute, tracepath, etc.). Пример: ```tcpdump -i eth1 icmp```.
  